local Players = game:GetService("Players")
local Lighting = game:GetService("Lighting")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local CollectionService = game:GetService("CollectionService")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UIS = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
if not LocalPlayer then
    LocalPlayer = Players.PlayerAdded:Wait()
end
local FLY_SPEED = 300
local TP_DISTANCE = 2500
local CHEST_OFFSET = Vector3.new(0, 2.5, 0)
local EMPTY_CHECK_DELAY = 1.2
local MAX_EMPTY_CHECK = 3
local HOP_DELAY = 1.5
local CHEST_COOLDOWN = 60
local RESET_CHEST_THRESHOLD = 3
local MIN_CHEST_DISTANCE = 10
local Tween
local NoclipConn
local TeamSet = false
local Farming = false
local Hopping = false
local IsResetting = false
local PendingChestCF = nil
local NoChestCount = 0
local ShouldResetAtChest = false
local ForcePositionEnabled = false
local CurrentChestMap = nil
local FarmEnabled = true
local ChestCount = 0
local autoFarmEnabled = false
local isHopping = false
local isDragging = false
local dragStartPos
local startContainerPos
local isClick = true
local dragThreshold = 10
local lastClickTime = 0
local CLICK_DELAY = 0.2
local hoverDebounce = false
local pulseConnection
local LastBeliValue = 0
local StatsHistory = {
    BeliIncreased = 0,
    ChestsCollected = 0
}
local CollectedChests = {}
local FailedChests = {}
local ActiveChests = {}
local OpenedChests = {}
local function SafeCall(func, ...)
    local success, result = pcall(func, ...)
    if not success then
        warn("ERROR in "..tostring(func)..": "..tostring(result))
        return nil
    end
    return result
end
local function GetChestId(chest)
    if not chest then return "invalid" end
    local pos = chest:GetPivot().Position
    return string.format("%d_%d_%d", 
        math.floor(pos.X), 
        math.floor(pos.Y), 
        math.floor(pos.Z)
    )
end
local function CleanupOldChests()
    local currentTime = tick()
    local chestsRemoved = 0
    local failedRemoved = 0
    for chestId, collectedTime in pairs(CollectedChests) do
        if currentTime - collectedTime > CHEST_COOLDOWN then
            CollectedChests[chestId] = nil
            chestsRemoved = chestsRemoved + 1
        end
    end   
    for chestId, data in pairs(FailedChests) do
        if currentTime - data.timestamp > 30 then
            FailedChests[chestId] = nil
            failedRemoved = failedRemoved + 1
        end
    end    
    if chestsRemoved > 0 or failedRemoved > 0 then
        print(string.format("Cleaned: %d old chests, %d failed chests", chestsRemoved, failedRemoved))
    end
end
local function ResetCollectedChests()
    print("Reset all chest list")
    CollectedChests = {}
    FailedChests = {}
    ActiveChests = {}
    OpenedChests = {}
end
if game.CoreGui:FindFirstChild("BananaButtonUI") then
    game.CoreGui.BananaButtonUI:Destroy()
end
local ButtonScreenGui = Instance.new("ScreenGui")
ButtonScreenGui.Name = "BananaButtonUI"
ButtonScreenGui.IgnoreGuiInset = true
ButtonScreenGui.ResetOnSpawn = false
ButtonScreenGui.DisplayOrder = 1000
ButtonScreenGui.Parent = game.CoreGui
local Container = Instance.new("Frame")
Container.Parent = ButtonScreenGui
Container.Size = UDim2.fromOffset(190, 62)
Container.Position = UDim2.fromOffset(50, 20)
Container.BackgroundColor3 = Color3.fromRGB(255, 170, 60)
Container.BackgroundTransparency = 0
Container.BorderSizePixel = 0
Container.ZIndex = 5
Container.Active = true
Container.Selectable = true
local ContainerCorner = Instance.new("UICorner")
ContainerCorner.CornerRadius = UDim.new(0, 18)
ContainerCorner.Parent = Container
local ContainerGlow = Instance.new("UIStroke", Container)
ContainerGlow.Color = Color3.fromRGB(255, 200, 100)
ContainerGlow.Thickness = 3
ContainerGlow.Transparency = 0
local InnerBackground = Instance.new("Frame")
InnerBackground.Parent = Container
InnerBackground.Size = UDim2.fromScale(0.95, 0.9)
InnerBackground.Position = UDim2.fromScale(0.025, 0.05)
InnerBackground.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
InnerBackground.BackgroundTransparency = 0.4
InnerBackground.BorderSizePixel = 0
InnerBackground.ZIndex = 6
local InnerCorner = Instance.new("UICorner")
InnerCorner.CornerRadius = UDim.new(0, 14)
InnerCorner.Parent = InnerBackground
local GlassEffect = Instance.new("Frame")
GlassEffect.Parent = InnerBackground
GlassEffect.Size = UDim2.fromScale(1, 1)
GlassEffect.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
GlassEffect.BackgroundTransparency = 0.95
GlassEffect.BorderSizePixel = 0
GlassEffect.ZIndex = 7
local GlassCorner = Instance.new("UICorner")
GlassCorner.CornerRadius = UDim.new(0, 14)
GlassCorner.Parent = GlassEffect
local Button = Instance.new("TextButton")
Button.Parent = InnerBackground
Button.Size = UDim2.fromScale(1, 1)
Button.Position = UDim2.fromScale(0, 0)
Button.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
Button.BackgroundTransparency = 0.6
Button.BorderSizePixel = 0
Button.AutoButtonColor = false
Button.Text = ""
Button.ZIndex = 10
Button.Active = true
local Corner = Instance.new("UICorner")
Corner.CornerRadius = UDim.new(0, 14)
Corner.Parent = Button
local Stroke = Instance.new("UIStroke", Button)
Stroke.Color = Color3.fromRGB(255, 170, 60)
Stroke.Thickness = 2
Stroke.Transparency = 0
Stroke.LineJoinMode = Enum.LineJoinMode.Round
local Glow = Instance.new("UIStroke", Button)
Glow.Color = Color3.fromRGB(255, 185, 90)
Glow.Thickness = 5
Glow.Transparency = 0.85
Glow.ZIndex = 9
local Noise = Instance.new("ImageLabel")
Noise.Parent = Button
Noise.Size = UDim2.fromScale(1, 1)
Noise.BackgroundTransparency = 1
Noise.Image = "rbxassetid://9968344105"
Noise.ImageTransparency = 0.96
Noise.ZIndex = 8
local ButtonText = Instance.new("TextLabel")
ButtonText.Parent = Button
ButtonText.Size = UDim2.fromScale(1, 1)
ButtonText.BackgroundTransparency = 1
ButtonText.Text = "Hop Server"
ButtonText.Font = Enum.Font.GothamBold
ButtonText.TextSize = 14
ButtonText.TextColor3 = Color3.fromRGB(255, 190, 90)
ButtonText.TextStrokeColor3 = Color3.fromRGB(120, 80, 30)
ButtonText.TextStrokeTransparency = 0.35
ButtonText.ZIndex = 11
local HintText = Instance.new("TextLabel")
HintText.Parent = Container
HintText.Size = UDim2.new(1, 0, 0.3, 0)
HintText.Position = UDim2.new(0, 0, -0.35, 0)
HintText.BackgroundTransparency = 1
HintText.Text = "Drag anywhere to move • Click to toggle"
HintText.Font = Enum.Font.Gotham
HintText.TextSize = 10
HintText.TextColor3 = Color3.fromRGB(255, 200, 100)
HintText.TextTransparency = 0.7
HintText.ZIndex = 5
task.delay(5, function()
    TweenService:Create(
        HintText,
        TweenInfo.new(1, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
        {
            TextTransparency = 1
        }
    ):Play()
    task.wait(1)
    HintText.Visible = false
end)
local function serverHop()
    if isHopping then return end
    isHopping = true    
    ResetCollectedChests()    
    local gameId = game.PlaceId
    local currentJobId = game.JobId
    local servers = {}       
    local success, result = pcall(function()
        return game:HttpGet("https://games.roblox.com/v1/games/" .. gameId .. "/servers/Public?sortOrder=Asc&limit=100")
    end)        
    if not success then
        warn("Không lấy được danh sách server.")
        isHopping = false
        return
    end       
    local data = HttpService:JSONDecode(result)
    for _, server in pairs(data.data) do
        if server.id ~= currentJobId and server.playing < server.maxPlayers then
            table.insert(servers, server.id)
        end
    end        
    if #servers > 0 then
        local randomServer = servers[math.random(1, #servers)]        
        ButtonText.Text = "Chuyển Server..."
        ButtonText.TextColor3 = Color3.fromRGB(100, 255, 100)        
        task.wait(1)       
        local teleportSuccess, teleportError = pcall(function()
            TeleportService:TeleportToPlaceInstance(gameId, randomServer, Players.LocalPlayer)
        end)        
        if not teleportSuccess then
            warn("Lỗi khi chuyển server:", teleportError)
            isHopping = false
        end
    else
        warn("Không tìm thấy server phù hợp.")
        isHopping = false
    end
end
local function startAutoHop()
    if autoFarmEnabled then
        spawn(function()
            while autoFarmEnabled and not isHopping do
                serverHop()
                task.wait(5)
            end
        end)
    end
end
local function playClickEffect()
    local clickTween = TweenService:Create(
        Container,
        TweenInfo.new(0.1, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
        {
            Size = UDim2.fromOffset(185, 58)
        }
    )
    
    local containerGlowTween = TweenService:Create(
        ContainerGlow,
        TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
        {
            Transparency = 0.2,
            Thickness = 4
        }
    )
    
    local buttonTween = TweenService:Create(
        Button,
        TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
        {
            BackgroundTransparency = 0.7
        }
    )
    
    clickTween:Play()
    containerGlowTween:Play()
    buttonTween:Play()
    
    task.delay(0.1, function()
        local resetTween = TweenService:Create(
            Container,
            TweenInfo.new(0.1, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
            {
                Size = UDim2.fromOffset(190, 62)
            }
        )
        
        local containerResetTween = TweenService:Create(
            ContainerGlow,
            TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
            {
                Transparency = 0,
                Thickness = 3
            }
        )
        
        local buttonResetTween = TweenService:Create(
            Button,
            TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
            {
                BackgroundTransparency = 0.6
            }
        )
        
        resetTween:Play()
        containerResetTween:Play()
        buttonResetTween:Play()
    end)
end

local function toggleAutoFarm()
    autoFarmEnabled = not autoFarmEnabled  
    if autoFarmEnabled then
        ButtonText.Text = "Đang Hop Server..."
        ButtonText.TextColor3 = Color3.fromRGB(100, 255, 100)       
        local containerTween = TweenService:Create(
            Container,
            TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
            {
                BackgroundColor3 = Color3.fromRGB(60, 255, 100),
                BackgroundTransparency = 0.1
            }
        )
        
        local glowTween = TweenService:Create(
            ContainerGlow,
            TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
            {
                Color = Color3.fromRGB(100, 255, 140)
            }
        )
        
        local strokeTween = TweenService:Create(
            Stroke,
            TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
            {
                Color = Color3.fromRGB(100, 255, 100)
            }
        )
        
        local innerTween = TweenService:Create(
            InnerBackground,
            TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
            {
                BackgroundTransparency = 0.5
            }
        )
        
        containerTween:Play()
        glowTween:Play()
        strokeTween:Play()
        innerTween:Play()
        startAutoHop()
    else
        ButtonText.Text = "Hop Server"
        ButtonText.TextColor3 = Color3.fromRGB(255, 190, 90)        
        local containerTween = TweenService:Create(
            Container,
            TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
            {
                BackgroundColor3 = Color3.fromRGB(255, 170, 60),
                BackgroundTransparency = 0
            }
        )
        
        local glowTween = TweenService:Create(
            ContainerGlow,
            TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
            {
                Color = Color3.fromRGB(255, 200, 100)
            }
        )
        
        local strokeTween = TweenService:Create(
            Stroke,
            TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
            {
                Color = Color3.fromRGB(255, 170, 60)
            }
        )
        
        local innerTween = TweenService:Create(
            InnerBackground,
            TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
            {
                BackgroundTransparency = 0.4
            }
        )
        
        containerTween:Play()
        glowTween:Play()
        strokeTween:Play()
        innerTween:Play()
    end
    
    print("Auto Hop Server:", autoFarmEnabled and "ENABLED" or "DISABLED")
end
local function startDrag(input)
    isDragging = true
    isClick = true
    dragStartPos = input.Position
    startContainerPos = Container.Position
    Container.BackgroundTransparency = 0.2
    InnerBackground.BackgroundTransparency = 0.5
    Button.BackgroundTransparency = 0.7
    ContainerGlow.Thickness = 4
    ContainerGlow.Transparency = 0.2
end
local function updateDrag(input)
    if not isDragging then return end    
    local delta = input.Position - dragStartPos
    local distanceMoved = delta.Magnitude    
    if distanceMoved > dragThreshold then
        isClick = false
        Container.Position = UDim2.new(
            startContainerPos.X.Scale,
            startContainerPos.X.Offset + delta.X,
            startContainerPos.Y.Scale,
            startContainerPos.Y.Offset + delta.Y
        )
    end
end
local function endDrag()
    if not isDragging then return end    
    isDragging = false
    Container.BackgroundTransparency = 0
    InnerBackground.BackgroundTransparency = 0.4
    Button.BackgroundTransparency = 0.6
    ContainerGlow.Thickness = 3
    ContainerGlow.Transparency = 0    
    local viewportSize = ButtonScreenGui.AbsoluteSize
    local containerSize = Container.AbsoluteSize
    local position = Container.Position    
    local minX = 0
    local maxX = viewportSize.X - containerSize.X
    local minY = 0
    local maxY = viewportSize.Y - containerSize.Y    
    local currentX = position.X.Offset
    local currentY = position.Y.Offset   
    if currentX < minX then
        Container.Position = UDim2.new(position.X.Scale, minX, position.Y.Scale, currentY)
    elseif currentX > maxX then
        Container.Position = UDim2.new(position.X.Scale, maxX, position.Y.Scale, currentY)
    end    
    if currentY < minY then
        Container.Position = UDim2.new(position.X.Scale, currentX, position.Y.Scale, minY)
    elseif currentY > maxY then
        Container.Position = UDim2.new(position.X.Scale, currentX, position.Y.Scale, maxY)
    end    
    return isClick
end
local function handleInputBegan(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1
    or input.UserInputType == Enum.UserInputType.Touch then
        startDrag(input)
        return true
    end
    return false
end
local function handleInputChanged(input)
    if isDragging and (input.UserInputType == Enum.UserInputType.MouseMovement
    or input.UserInputType == Enum.UserInputType.Touch) then
        updateDrag(input)
    end
end
local function handleInputEnded(input)
    if (input.UserInputType == Enum.UserInputType.MouseButton1
    or input.UserInputType == Enum.UserInputType.Touch)
    and isDragging then
        local wasClick = endDrag()
        if wasClick and (tick() - lastClickTime) > CLICK_DELAY then
            lastClickTime = tick()
            playClickEffect()
            task.wait(0.12)
            toggleAutoFarm()
        end
    end
end
Container.InputBegan:Connect(handleInputBegan)
Container.InputChanged:Connect(handleInputChanged)
Container.InputEnded:Connect(handleInputEnded)
Button.InputBegan:Connect(handleInputBegan)
Button.InputChanged:Connect(handleInputChanged)
Button.InputEnded:Connect(handleInputEnded)
Container.MouseEnter:Connect(function()
    if not isDragging and not hoverDebounce then
        hoverDebounce = true
        local hoverTween = TweenService:Create(
            Container,
            TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
            {
                BackgroundTransparency = 0.1
            }
        )
        local glowTween = TweenService:Create(
            ContainerGlow,
            TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
            {
                Thickness = 4
            }
        )
        hoverTween:Play()
        glowTween:Play()
        task.wait(0.2)
        hoverDebounce = false
    end
end)
Container.MouseLeave:Connect(function()
    if not isDragging and not hoverDebounce then
        hoverDebounce = true
        local leaveTween = TweenService:Create(
            Container,
            TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
            {
                BackgroundTransparency = 0
            }
        )
        local glowTween = TweenService:Create(
            ContainerGlow,
            TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
            {
                Thickness = 3
            }
        )
        leaveTween:Play()
        glowTween:Play()
        task.wait(0.2)
        hoverDebounce = false
    end
end)
local function updatePulseEffect()
    if pulseConnection then
        pulseConnection:Disconnect()
    end
    pulseConnection = RunService.Heartbeat:Connect(function()
        if autoFarmEnabled then
            local time = tick()
            local pulse = math.sin(time * 5) * 0.1 + 0.9
            ContainerGlow.Transparency = 0.2 + (0.3 * (1 - pulse))
            Glow.Transparency = 0.7 + (0.15 * (1 - pulse))
            InnerBackground.BackgroundTransparency = 0.4 + (0.1 * (1 - pulse))
            Button.BackgroundTransparency = 0.6 + (0.1 * (1 - pulse))
        else
            ContainerGlow.Transparency = 0
            Glow.Transparency = 0.85
            InnerBackground.BackgroundTransparency = 0.4
            Button.BackgroundTransparency = 0.6
        end
    end)
end
updatePulseEffect()
local function playToggleEffect()
    if autoFarmEnabled then
        local scaleTween = TweenService:Create(
            Container,
            TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out),
            {
                Size = UDim2.fromOffset(195, 65)
            }
        )
        scaleTween:Play()
        task.delay(0.3, function()
            TweenService:Create(
                Container,
                TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
                {
                    Size = UDim2.fromOffset(190, 62)
                }
            ):Play()
        end)
    end
end
local originalToggleAutoFarm = toggleAutoFarm
toggleAutoFarm = function()
    playToggleEffect()
    originalToggleAutoFarm()
    task.wait(0.5)
    updatePulseEffect()
end
if game.CoreGui:FindFirstChild("BananaUI") then
    game.CoreGui.BananaUI:Destroy()
end
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "BananaUI"
ScreenGui.IgnoreGuiInset = true
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = game.CoreGui
local WorldBlur = Instance.new("BlurEffect")
WorldBlur.Name = "BananaBlur"
WorldBlur.Size = 18
WorldBlur.Enabled = true
WorldBlur.Parent = Lighting
local Main = Instance.new("Frame", ScreenGui)
Main.Size = UDim2.new(0.75,0,0.72,0)
Main.Position = UDim2.new(0.5,0,0.5,0)
Main.AnchorPoint = Vector2.new(0.5,0.5)
Main.BackgroundColor3 = Color3.fromRGB(12,12,12)
Main.BackgroundTransparency = 0.25
Main.BorderSizePixel = 0
Instance.new("UICorner",Main).CornerRadius = UDim.new(0,16)
local StrokeMain = Instance.new("UIStroke",Main)
StrokeMain.Color = Color3.fromRGB(255,170,60)
StrokeMain.Thickness = 2
local NoiseMain = Instance.new("ImageLabel",Main)
NoiseMain.Size = UDim2.new(1,0,1,0)
NoiseMain.BackgroundTransparency = 1
NoiseMain.Image = "rbxassetid://9968344105"
NoiseMain.ImageTransparency = 0.92
NoiseMain.ZIndex = 2
local Title = Instance.new("TextLabel",Main)
Title.Size = UDim2.new(1,0,0,55)
Title.BackgroundTransparency = 1
Title.Text = "Status Item : khanhlyHUB Stats Checker"
Title.TextColor3 = Color3.fromRGB(255,190,90)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 20
Title.ZIndex = 3
local AvatarIcon = Instance.new("ImageLabel",Main)
AvatarIcon.Size = UDim2.new(0,50,0,50)
AvatarIcon.Position = UDim2.new(0.5,0,0,50)
AvatarIcon.AnchorPoint = Vector2.new(0.5,0)
AvatarIcon.BackgroundTransparency = 1
AvatarIcon.Image = "rbxassetid://92963593524144"
AvatarIcon.ZIndex = 4
local Body = Instance.new("Frame",Main)
Body.Size = UDim2.new(1,-40,1,-100)
Body.Position = UDim2.new(0,20,0,80)
Body.BackgroundTransparency = 1
local StatsBox = Instance.new("Frame",Body)
StatsBox.Size = UDim2.new(0.48,10,1,0)
StatsBox.BackgroundColor3 = Color3.fromRGB(18,18,18)
StatsBox.BackgroundTransparency = 0.3
StatsBox.BorderSizePixel = 0
Instance.new("UICorner",StatsBox).CornerRadius = UDim.new(0,14)
Instance.new("UIStroke",StatsBox).Color = Color3.fromRGB(255,170,60)
local StatsTitle = Instance.new("TextLabel",StatsBox)
StatsTitle.Size = UDim2.new(1,0,0,30)
StatsTitle.BackgroundTransparency = 1
StatsTitle.Text = "Account Stats"
StatsTitle.TextColor3 = Color3.fromRGB(255,180,90)
StatsTitle.Font = Enum.Font.GothamBold
StatsTitle.TextSize = 16
local LevelLabel = Instance.new("TextLabel", StatsBox)
LevelLabel.Size = UDim2.new(1,-20,0,22)
LevelLabel.Position = UDim2.new(0,10,0,40)
LevelLabel.BackgroundTransparency = 1
LevelLabel.TextXAlignment = Enum.TextXAlignment.Left
LevelLabel.TextColor3 = Color3.fromRGB(235,235,235)
LevelLabel.Font = Enum.Font.Gotham
LevelLabel.TextSize = 14
LevelLabel.Text = "Level : Loading..."
local BeliLabel = Instance.new("TextLabel", StatsBox)
BeliLabel.Size = UDim2.new(1,-20,0,22)
BeliLabel.Position = UDim2.new(0,10,0,66)
BeliLabel.BackgroundTransparency = 1
BeliLabel.TextXAlignment = Enum.TextXAlignment.Left
BeliLabel.TextColor3 = Color3.fromRGB(235,235,235)
BeliLabel.Font = Enum.Font.Gotham
BeliLabel.TextSize = 14
BeliLabel.Text = "Beli : Loading..."
local BeliIncreaseLabel = Instance.new("TextLabel", StatsBox)
BeliIncreaseLabel.Size = UDim2.new(1,-20,0,22)
BeliIncreaseLabel.Position = UDim2.new(0,10,0,92)
BeliIncreaseLabel.BackgroundTransparency = 1
BeliIncreaseLabel.TextXAlignment = Enum.TextXAlignment.Left
BeliIncreaseLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
BeliIncreaseLabel.Font = Enum.Font.Gotham
BeliIncreaseLabel.TextSize = 14
BeliIncreaseLabel.Text = "+Beli: 0"
BeliIncreaseLabel.Visible = false
local ChestLabel = Instance.new("TextLabel", StatsBox)
ChestLabel.Size = UDim2.new(1,-20,0,22)
ChestLabel.Position = UDim2.new(0,10,0,118)
ChestLabel.BackgroundTransparency = 1
ChestLabel.TextXAlignment = Enum.TextXAlignment.Left
ChestLabel.TextColor3 = Color3.fromRGB(235,235,235)
ChestLabel.Font = Enum.Font.Gotham
ChestLabel.TextSize = 14
ChestLabel.Text = "Chest Count : 0"
local ChestIncreaseLabel = Instance.new("TextLabel", StatsBox)
ChestIncreaseLabel.Size = UDim2.new(1,-20,0,22)
ChestIncreaseLabel.Position = UDim2.new(0,10,0,144)
ChestIncreaseLabel.BackgroundTransparency = 1
ChestIncreaseLabel.TextXAlignment = Enum.TextXAlignment.Left
ChestIncreaseLabel.TextColor3 = Color3.fromRGB(255, 200, 50)
ChestIncreaseLabel.Font = Enum.Font.Gotham
ChestIncreaseLabel.TextSize = 14
ChestIncreaseLabel.Text = "+Chest: 0"
ChestIncreaseLabel.Visible = false
local PlayerInfoBox = Instance.new("Frame",Body)
PlayerInfoBox.Size = UDim2.new(0.48,0,1,0)
PlayerInfoBox.Position = UDim2.new(0.52,0,0,0)
PlayerInfoBox.BackgroundColor3 = Color3.fromRGB(18,18,18)
PlayerInfoBox.BackgroundTransparency = 0.32
PlayerInfoBox.BorderSizePixel = 0
Instance.new("UICorner",PlayerInfoBox).CornerRadius = UDim.new(0,14)
local InfoStroke = Instance.new("UIStroke",PlayerInfoBox)
InfoStroke.Color = Color3.fromRGB(170,120,255)
InfoStroke.Thickness = 2
local PlayerAvatar = Instance.new("ImageLabel",PlayerInfoBox)
PlayerAvatar.Size = UDim2.new(0,70,0,70)
PlayerAvatar.Position = UDim2.new(0.5,0,0,20)
PlayerAvatar.AnchorPoint = Vector2.new(0.5,0)
PlayerAvatar.BackgroundTransparency = 1
PlayerAvatar.ZIndex = 5
PlayerAvatar.Image = "rbxassetid://11306223468"
Instance.new("UICorner",PlayerAvatar).CornerRadius = UDim.new(1,0)
local AvatarStroke = Instance.new("UIStroke",PlayerAvatar)
AvatarStroke.Color = Color3.fromRGB(180,130,255)
AvatarStroke.Thickness = 2
task.spawn(function()
    local ok, img = pcall(function()
        return Players:GetUserThumbnailAsync(
            LocalPlayer.UserId,
            Enum.ThumbnailType.HeadShot,
            Enum.ThumbnailSize.Size420x420
        )
    end)
    if ok and img and img ~= "" then
        PlayerAvatar.Image = img
    end
end)
local NameLabel = Instance.new("TextLabel",PlayerInfoBox)
NameLabel.Size = UDim2.new(1,-20,0,24)
NameLabel.Position = UDim2.new(0.5,0,0,105)
NameLabel.AnchorPoint = Vector2.new(0.5,0)
NameLabel.BackgroundTransparency = 1
NameLabel.Text = "Name : "..LocalPlayer.Name
NameLabel.TextColor3 = Color3.fromRGB(255,220,150)
NameLabel.Font = Enum.Font.GothamBold
NameLabel.TextSize = 15
NameLabel.TextXAlignment = Enum.TextXAlignment.Center
NameLabel.ZIndex = 6
local TimeLabel = Instance.new("TextLabel",PlayerInfoBox)
TimeLabel.Size = UDim2.new(1,-20,0,22)
TimeLabel.Position = UDim2.new(0.5,0,0,132)
TimeLabel.AnchorPoint = Vector2.new(0.5,0)
TimeLabel.BackgroundTransparency = 1
TimeLabel.Text = "Active Time : 0s"
TimeLabel.TextColor3 = Color3.fromRGB(235,235,235)
TimeLabel.Font = Enum.Font.Gotham
TimeLabel.TextSize = 14
TimeLabel.TextXAlignment = Enum.TextXAlignment.Center
TimeLabel.ZIndex = 6
local function formatNumber(num)
    if not num then return "0" end
    local formatted = tostring(num)
    while true do
        formatted, k = string.gsub(formatted, "^(-?%d+)(%d%d%d)", '%1,%2')
        if k == 0 then break end
    end
    return formatted
end
local function updateChestCount()
    if ChestLabel and ChestLabel.Parent then
        ChestLabel.Text = "Chest Count : " .. formatNumber(ChestCount)
    end
end
local function showTemporaryIncrease(label, value, duration)
    label.Text = value
    label.Visible = true
    label.TextTransparency = 0
    local tween = TweenService:Create(
        label,
        TweenInfo.new(duration, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
        {
            TextTransparency = 1
        }
    )
    tween:Play()
    
    tween.Completed:Connect(function()
        label.Visible = false
    end)
end
local function incrementChestCount()
    ChestCount = ChestCount + 1
    updateChestCount()   
    StatsHistory.ChestsCollected = StatsHistory.ChestsCollected + 1
    if ChestIncreaseLabel and ChestIncreaseLabel.Parent then
        showTemporaryIncrease(ChestIncreaseLabel, "+Chest: " .. StatsHistory.ChestsCollected, 2)
    end   
    print("CHEST COUNT: "..ChestCount)
end
local function checkBeliIncrease()
    local plr = game:GetService("Players").LocalPlayer
    if not plr then return end    
    if plr:FindFirstChild("Data") and plr.Data:FindFirstChild("Beli") then
        local currentBeli = plr.Data.Beli.Value
        local increase = currentBeli - LastBeliValue        
        if increase > 0 then
            StatsHistory.BeliIncreased = StatsHistory.BeliIncreased + increase            
            if BeliIncreaseLabel and BeliIncreaseLabel.Parent then
                showTemporaryIncrease(BeliIncreaseLabel, "+Beli: " .. formatNumber(increase), 2)
            end            
            print("Beli increased by: "..formatNumber(increase))
        end       
        LastBeliValue = currentBeli
    end
end
local function updateStats()
    local plr = game:GetService("Players").LocalPlayer    
    if plr and plr:FindFirstChild("Data") then
        if plr.Data:FindFirstChild("Level") then
            LevelLabel.Text = "Level : " .. formatNumber(plr.Data.Level.Value)
        else
            LevelLabel.Text = "Level : Not Found"
        end
        if plr.Data:FindFirstChild("Beli") then
            local currentBeli = plr.Data.Beli.Value
            BeliLabel.Text = "Beli : " .. formatNumber(currentBeli)           
            checkBeliIncrease()
        else
            BeliLabel.Text = "Beli : Not Found"
        end
    else
        LevelLabel.Text = "Level : Data not loaded"
        BeliLabel.Text = "Beli : Data not loaded"
    end
end
local function setupDataConnections()
    local plr = game:GetService("Players").LocalPlayer
    if not plr:FindFirstChild("Data") then
        plr.ChildAdded:Connect(function(child)
            if child.Name == "Data" then
                task.wait(0.5)
                setupDataConnections()
            end
        end)
        return
    end       
    local data = plr.Data  
    if data:FindFirstChild("Level") then
        data.Level.Changed:Connect(function()
            updateStats()
        end)
    end    
    if data:FindFirstChild("Beli") then
        data.Beli.Changed:Connect(function()
            updateStats()
        end)        
        LastBeliValue = data.Beli.Value
    end 
    updateStats()
end
local function SetTeam()
    if TeamSet then return true end    
    print("Setting team to Marines...")   
    local success = SafeCall(function()
        local remote = ReplicatedStorage:FindFirstChild("Remotes")
        if remote then
            remote = remote:FindFirstChild("CommF_")
            if remote then
                remote:InvokeServer("SetTeam", "Marines")
                TeamSet = true
                print("Team set successfully")
                return true
            end
        end
        return false
    end)  
    if success then
        return true
    else
        task.wait(1)
        SafeCall(function()
            ReplicatedStorage.Remotes.CommF_:InvokeServer("SetTeam", "Marines")
        end)
        TeamSet = true
        print("Team set (fallback)")
        return true
    end
end
local function EnableNoclip()
    if NoclipConn then return end
    NoclipConn = RunService.Stepped:Connect(function()
        local char = LocalPlayer.Character
        if char then
            for _,v in ipairs(char:GetDescendants()) do
                if v:IsA("BasePart") then
                    v.CanCollide = false
                end
            end
        end
    end)
end
local function DisableNoclip()
    if NoclipConn then
        NoclipConn:Disconnect()
        NoclipConn = nil
    end
end
local function StopTween()
    if Tween then
        Tween:Cancel()
        Tween = nil
    end
end
local function EnableNetworkManipulation()
    SafeCall(function()
        if LocalPlayer.Character then
            LocalPlayer.Character:SetNetworkOwner(nil)
        end
    end)
end
local function DisableNetworkManipulation()
    SafeCall(function()
        if LocalPlayer.Character then
            LocalPlayer.Character:SetNetworkOwner(game.Players)
        end
    end)
end
local function tp1(cf)
    StopTween()   
    local char = LocalPlayer.Character
    if not char then
        char = LocalPlayer.CharacterAdded:Wait()
        task.wait(0.5)
    end  
    local hrp = char:WaitForChild("HumanoidRootPart", 5)
    if not hrp then return false end   
    print("Teleporting...")    
    EnableNetworkManipulation()
    EnableNoclip()
    hrp.CFrame = cf
    DisableNoclip()
    task.wait(0.1)
    DisableNetworkManipulation()  
    return true
end
local function topos(cf)
    StopTween()   
    local char = LocalPlayer.Character
    if not char then
        char = LocalPlayer.CharacterAdded:Wait()
        task.wait(0.5)
    end   
    local hrp = char:WaitForChild("HumanoidRootPart", 5)
    if not hrp then return false end    
    local dist = (hrp.Position - cf.Position).Magnitude   
    if dist > 10000 then
        return tp1(cf)
    end 
    local time = math.clamp(dist / FLY_SPEED, 0.1, 3)   
    EnableNoclip()
    Tween = TweenService:Create(
        hrp,
        TweenInfo.new(time, Enum.EasingStyle.Linear),
        {CFrame = cf}
    )
    Tween:Play()
    Tween.Completed:Wait()
    DisableNoclip()   
    return true
end
local function ForceLockPosition(cf)
    if ForcePositionEnabled then return end
    ForcePositionEnabled = true   
    print("Locking position...")    
    EnableNetworkManipulation()    
    local char = LocalPlayer.Character
    if not char then
        ForcePositionEnabled = false
        return false
    end    
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then
        ForcePositionEnabled = false
        return false
    end    
    EnableNoclip()   
    local startTime = tick()
    while tick() - startTime < 1.5 do
        SafeCall(function()
            hrp.CFrame = cf
            hrp.Velocity = Vector3.new(0, 0, 0)
            hrp.RotVelocity = Vector3.new(0, 0, 0)
        end)
        task.wait(0.05)
    end    
    DisableNoclip()
    DisableNetworkManipulation()
    ForcePositionEnabled = false   
    print("Position locked")
    return true
end
local function IsChestValid(chest)
    if not chest then return false end
    if not chest:IsDescendantOf(workspace) then return false end
    if chest:GetAttribute("IsDisabled") then return false end    
    if chest:FindFirstChild("ProximityPrompt") then
        return true
    end    
    local chestName = chest.Name:lower()
    if chestName:find("chest") or chestName:find("reward") then
        return true
    end    
    return false
end
local function IsChestCollectable(chest)
    if not IsChestValid(chest) then return false end   
    local chestId = GetChestId(chest)
    local currentTime = tick()    
    if OpenedChests[chest] then
        return false
    end    
    if ActiveChests[chestId] then
        return false
    end    
    if CollectedChests[chestId] then
        local timeSinceCollected = currentTime - CollectedChests[chestId]
        if timeSinceCollected < CHEST_COOLDOWN then
            return false
        else
            CollectedChests[chestId] = nil
        end
    end    
    if FailedChests[chestId] then
        local failedData = FailedChests[chestId]
        if failedData.attempts >= 3 and currentTime - failedData.timestamp < 120 then
            return false
        end
    end   
    return true
end
local function MarkChestAsProcessing(chest)
    local chestId = GetChestId(chest)
    ActiveChests[chestId] = true
end
local function UnmarkChestAsProcessing(chest)
    local chestId = GetChestId(chest)
    ActiveChests[chestId] = nil
end
local function MarkChestAsCollected(chest)
    local chestId = GetChestId(chest)
    CollectedChests[chestId] = tick()
    OpenedChests[chest] = true
    UnmarkChestAsProcessing(chest)
end
local function MarkChestAsFailed(chest)
    local chestId = GetChestId(chest)
    local currentTime = tick()
    if not FailedChests[chestId] then
        FailedChests[chestId] = {
            timestamp = currentTime,
            attempts = 1
        }
    else
        FailedChests[chestId].attempts = FailedChests[chestId].attempts + 1
        FailedChests[chestId].timestamp = currentTime
    end
    
    UnmarkChestAsProcessing(chest)
    
    if FailedChests[chestId].attempts >= 3 then
        print("Chest "..chestId.." failed 3 times, will skip for 2 minutes")
    end
end
local function TouchChest(chest)
    if not chest or OpenedChests[chest] then
        return false
    end
    local char = LocalPlayer.Character
    if not char then return false end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return false end
    local chestCF = chest:GetPivot() * CFrame.new(0, 2.5, 0)
    hrp.CFrame = chestCF
    task.wait(0.1)
    firetouchinterest(hrp, chest, 0)
    task.wait(0.05)
    firetouchinterest(hrp, chest, 1)
    incrementChestCount()
    MarkChestAsCollected(chest)    
    print("OPENED CHEST: "..GetChestId(chest))
    return true
end
local function IsPlayerAlive()
    local char = LocalPlayer.Character
    if not char then return false end
    local humanoid = char:FindFirstChildOfClass("Humanoid")
    return humanoid and humanoid.Health > 0
end
local function SafeReset(cf)
    if IsResetting then return false end
    IsResetting = true    
    print("Resetting at chest position...")   
    PendingChestCF = cf
    ShouldResetAtChest = true
    CurrentChestMap = cf 
    local char = LocalPlayer.Character
    if char then
        local humanoid = char:FindFirstChildOfClass("Humanoid")
        if humanoid and humanoid.Health > 0 then
            humanoid.Health = 0
        end
    end    
    task.wait(2)
    IsResetting = false
    return true
end
local function HopServer()
    if Hopping then return end
    Hopping = true   
    print("Hopping server...")
    ResetCollectedChests()    
    task.wait(HOP_DELAY)    
    SafeCall(function()
        local servers = {}
        local data = HttpService:JSONDecode(
            game:HttpGet("https://games.roblox.com/v1/games/"..game.PlaceId.."/servers/Public?sortOrder=Asc&limit=100")
        )
        
        if data and data.data then
            for _, server in ipairs(data.data) do
                if server.playing < server.maxPlayers and server.id ~= game.JobId then
                    table.insert(servers, server.id)
                end
            end
        end        
        if #servers > 0 then
            TeleportService:TeleportToPlaceInstance(
                game.PlaceId,
                servers[math.random(#servers)],
                LocalPlayer
            )
        else
            TeleportService:Teleport(game.PlaceId, LocalPlayer)
        end
    end)
end
local function FindNearestChest()
    CleanupOldChests()    
    local char = LocalPlayer.Character
    if not char then return nil end    
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return nil end    
    local allChests = CollectionService:GetTagged("_ChestTagged")
    local validChests = {}    
    for _, chest in ipairs(allChests) do
        if IsChestCollectable(chest) then
            table.insert(validChests, chest)
        end
    end    
    if #validChests == 0 then
        return nil
    end    
    local nearest = nil
    local minDist = math.huge
    for _, chest in ipairs(validChests) do
        local dist = (chest:GetPivot().Position - hrp.Position).Magnitude
        if dist < minDist then
            minDist = dist
            nearest = chest
        end
    end    
    return nearest, minDist
end
local function HandleDistantChest(cf, chest)
    print("Handling distant chest...")    
    tp1(cf)
    task.wait(0.5)    
    ForceLockPosition(cf)
    task.wait(0.5)    
    SafeReset(cf)   
    return true
end
local function HandleNearChest(cf, chest)
    MarkChestAsProcessing(chest)    
    topos(cf)
    task.wait(0.2)    
    local hrp = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if hrp then
        local dist = (hrp.Position - cf.Position).Magnitude
        if dist > 30 then
            print("Distance still too far: "..math.floor(dist))
            MarkChestAsFailed(chest)
            return false
        end
    end    
    local collected = TouchChest(chest)    
    if collected then
        task.wait(0.3)
        return true
    else
        MarkChestAsFailed(chest)
        task.wait(0.5)
        return false
    end
end
local function AutoFarmChest()
    if Farming then return end
    Farming = true
    FarmEnabled = true
    NoChestCount = 0   
    print("Starting chest farm...")
    ResetCollectedChests()   
    while FarmEnabled and Farming do
        if not IsPlayerAlive() then
            task.wait(1)
            continue
        end        
        CleanupOldChests()        
        local nearest, distance = FindNearestChest()      
        if not nearest then
            NoChestCount = NoChestCount + 1
            print("No chests ("..NoChestCount.."/"..MAX_EMPTY_CHECK..")")            
            if NoChestCount >= RESET_CHEST_THRESHOLD then
                print("Try reset chest list...")
                ResetCollectedChests()
                task.wait(1)
                continue
            end            
            if NoChestCount >= MAX_EMPTY_CHECK then
                print("Checked many times, hopping server...")
                Farming = false
                HopServer()
                break
            end            
            task.wait(EMPTY_CHECK_DELAY)
            continue
        else
            NoChestCount = 0
        end        
        local cf = nearest:GetPivot() * CFrame.new(CHEST_OFFSET)
        print("Chest distance: "..math.floor(distance).." studs")        
        if distance > TP_DISTANCE then
            print("Distant chest detected")
            if HandleDistantChest(cf, nearest) then
                Farming = false
                break
            end
        else
            print("Near chest detected")
            HandleNearChest(cf, nearest)
        end        
        task.wait(0.3)
    end    
    Farming = false
    print("Farm stopped. Total chests: "..ChestCount)
end
local function HandleRespawn()
    print("RESPAWN")    
    StopTween()
    DisableNoclip()
    DisableNetworkManipulation()   
    task.wait(2)    
    SetTeam()   
    if ShouldResetAtChest and PendingChestCF then
        print("Respawning at chest location...")        
        local char = LocalPlayer.Character
        if char and char:FindFirstChild("HumanoidRootPart") then
            local hrp = char:FindFirstChild("HumanoidRootPart")           
            tp1(PendingChestCF)
            task.wait(0.5)            
            local nearest = FindNearestChest()
            if nearest then
                local dist = (nearest:GetPivot().Position - hrp.Position).Magnitude
                if dist < 50 then
                    print("Opening chest...")
                    TouchChest(nearest)
                    task.wait(0.5)
                end
            end            
            ShouldResetAtChest = false
            PendingChestCF = nil
            CurrentChestMap = nil
        end
    end
    
    IsResetting = false    
    if not Hopping then
        print("Resuming farm...")
        task.wait(1)
        AutoFarmChest()
    end
end
local function Initialize()
    print("CHEST FARM")    
    updateChestCount()
    updateStats()    
    task.wait(3)    
    if not ReplicatedStorage:FindFirstChild("Remotes") then
        warn("Remotes not found!")
        return
    end    
    SetTeam()    
    if not LocalPlayer.Character then
        print("Waiting for character...")
        LocalPlayer.CharacterAdded:Wait()
        task.wait(2)
    end    
    if IsPlayerAlive() then
        print("Player ready, starting farm...")
        task.wait(1)
        AutoFarmChest()
    else
        print("Player dead, waiting for respawn...")
    end
end
task.spawn(function()
    while true do
        updateStats()
        task.wait(1)
    end
end)
task.spawn(setupDataConnections)
local startTime = os.clock()
task.spawn(function()
    while PlayerInfoBox.Parent do
        TimeLabel.Text = "Active Time : "..math.floor(os.clock()-startTime).."s"
        task.wait(1)
    end
end)
LocalPlayer.CharacterAdded:Connect(function()
    task.spawn(HandleRespawn)
end)
LocalPlayer.CharacterRemoving:Connect(function()
    StopTween()
    DisableNoclip()
end)
task.spawn(function()
    while task.wait(5) do
        if Farming and IsPlayerAlive() then
            CleanupOldChests()
        end
    end
end)
ScreenGui.AncestryChanged:Connect(function(_,p)
    if not p then
        WorldBlur:Destroy()
    end
end)
ButtonScreenGui.Destroying:Connect(function()
    if pulseConnection then
        pulseConnection:Disconnect()
    end
end)
task.spawn(Initialize)
print("khanhlyHUB Stats Checker - "..LocalPlayer.Name)
local Players = game:GetService("Players")
local Lighting = game:GetService("Lighting")
local Workspace = game:GetService("Workspace")
local Terrain = Workspace:FindFirstChildOfClass("Terrain")
Lighting.FogStart = 1e9
Lighting.FogEnd = 1e9
for _, v in ipairs(Lighting:GetChildren()) do
    if v:IsA("Sky") or v:IsA("Atmosphere") then
        v:Destroy()
    elseif v:IsA("PostEffect") then
        v.Enabled = false
    end
end
Lighting.GlobalShadows = false
Lighting.ClockTime = 12
Lighting.Brightness = 1.2
Lighting.OutdoorAmbient = Color3.new(1,1,1)
if Terrain then
    Terrain.WaterWaveSize = 0
    Terrain.WaterWaveSpeed = 0
    Terrain.WaterReflectance = 0
    Terrain.WaterTransparency = 1
end
local function IsPlayerModel(model)
    return Players:GetPlayerFromCharacter(model) ~= nil
end
local function IsTreeObject(obj)
    local n = obj.Name:lower()
    if n:find("tree") or n:find("leaf") or n:find("bush")
        or n:find("foliage") or n:find("plant") or n:find("palm") then
        return true
    end
    if obj:IsA("MeshPart") then
        return true
    end
    return false
end
local function Clean(v)
    if v:IsA("Model") then
        if v:FindFirstChildOfClass("Humanoid") and not IsPlayerModel(v) then
            v:Destroy()
            return
        end
        if IsTreeObject(v) then
            v:Destroy()
            return
        end
    end
    if v:IsA("BasePart") then
        v.Material = Enum.Material.SmoothPlastic
        v.CastShadow = false
        v.Reflectance = 0
        v.Color = Color3.fromRGB(130,130,130)
    end
    if v:IsA("Decal") or v:IsA("Texture") then
        v:Destroy()
    elseif v:IsA("ParticleEmitter") then
        v:Destroy()
    elseif v:IsA("Trail") then
        v:Destroy()
    elseif v:IsA("Fire")
        or v:IsA("Smoke")
        or v:IsA("SpotLight")
        or v:IsA("PointLight")
        or v:IsA("SurfaceLight") then
        v.Enabled = false
    end
end
for _, v in ipairs(Workspace:GetDescendants()) do
    Clean(v)
end
Workspace.DescendantAdded:Connect(function(v)
    task.wait()
    Clean(v)
end)

local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local CoreGui = game:GetService("CoreGui")
local Settings = {
    AntiAdmin = {
        Enabled = true,
        AdminList = {
            "red_game43", "rip_indra", "Axiore", "Polkster", "wenlocktoad",
            "Daigrock", "toilamvidamme", "oofficialnoobie", "Uzoth", "Azarth",
            "arlthmetic", "Death_King", "Lunoven", "TheGreateAced", "rip_fud",
            "drip_mama", "layandikit12", "Hingoi"
        },
        HopDelay = 5,
        CheckInterval = 30
    },
    AutoRejoin = {
        Enabled = true, 
        MaxAttempts = 5,
        RejoinDelay = 5,
        CurrentAttempts = 0
    }
}

local function IsAdmin(playerName)
    for _, adminName in pairs(Settings.AntiAdmin.AdminList) do
        if string.lower(playerName) == string.lower(adminName) then
            return true
        end
    end
    return false
end
local function FindNewServer()
    local servers = {}
    local nextCursor = ""  
    repeat
        local success, response = pcall(function()
            return HttpService:JSONDecode(game:HttpGet(
                "https://games.roblox.com/v1/games/" .. game.PlaceId .. 
                "/servers/Public?sortOrder=Asc&limit=100&cursor=" .. nextCursor
            ))
        end)      
        if success and response and response.data then
            for _, server in pairs(response.data) do
                if server.playing < server.maxPlayers and server.id ~= game.JobId then
                    table.insert(servers, server.id)
                end
            end
            nextCursor = response.nextPageCursor or ""
        else
            break
        end
    until #servers >= 3 or nextCursor == ""    
    return #servers > 0 and servers[math.random(1, #servers)] or nil
end
local function HopToNewServer()
    if not Settings.AntiAdmin.Enabled then return end    
    print("[Protection] Đang tìm server mới...")    
    local newServerId = FindNewServer()
    if newServerId then
        print("[Protection] Đang chuyển sang server: " .. newServerId)        
        game.StarterGui:SetCore("SendNotification", {
            Title = "Hiru Hub",
            Text = "Phát hiện admin! Đang chuyển server...",
            Duration = 3
        })       
        task.wait(Settings.AntiAdmin.HopDelay)        
        TeleportService:TeleportToPlaceInstance(game.PlaceId, newServerId, Players.LocalPlayer)
    else
        print("[Protection] Không tìm thấy server phù hợp!")
    end
end
local function CheckForAdmins()
    if not Settings.AntiAdmin.Enabled then return end    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= Players.LocalPlayer and IsAdmin(player.Name) then
            print("[Protection] Phát hiện admin: " .. player.Name)
            HopToNewServer()
            return
        end
    end
end
local function IsKickPromptVisible()
    local promptGui = CoreGui:FindFirstChild("RobloxPromptGui")
    if promptGui then
        local promptOverlay = promptGui:FindFirstChild("promptOverlay")
        if promptOverlay then
            for _, child in pairs(promptOverlay:GetChildren()) do
                if child.Name == "ErrorPrompt" then
                    local messageArea = child:FindFirstChild("MessageArea")
                    if messageArea and messageArea:FindFirstChild("ErrorFrame") then
                        return true
                    end
                end
            end
        end
    end
    return false
end
local function PerformRejoin()
    if not Settings.AutoRejoin.Enabled or 
       Settings.AutoRejoin.CurrentAttempts >= Settings.AutoRejoin.MaxAttempts then
        print("[Protection] Đã đạt giới hạn rejoin!")
        return
    end  
    Settings.AutoRejoin.CurrentAttempts = Settings.AutoRejoin.CurrentAttempts + 1  
    print(string.format(
        "[Protection] Rejoin lần %d/%d",
        Settings.AutoRejoin.CurrentAttempts,
        Settings.AutoRejoin.MaxAttempts
    ))  
    game.StarterGui:SetCore("SendNotification", {
        Title = "KhanhlyHub",
        Text = "Đã bị kick! Đang rejoin...",
        Duration = 3
    })    
    task.wait(Settings.AutoRejoin.RejoinDelay)    
    local success = pcall(function()
        TeleportService:Teleport(game.PlaceId, Players.LocalPlayer)
    end)    
    if not success then
        task.wait(Settings.AutoRejoin.RejoinDelay)
        PerformRejoin()
    end
end
local function InitProtectionSystem()
    print("[Protection] Đang khởi động hệ thống bảo vệ...")
    if Settings.AntiAdmin.Enabled then
        print("[Protection] Anti-Admin: Đã bật")
        game.StarterGui:SetCore("SendNotification", {
            Title = "KhanhlyHub",
            Text = "Anti-Admin: Đã bật!",
            Duration = 3
        })
        CheckForAdmins()
        Players.PlayerAdded:Connect(function(player)
            task.wait(1)
            if Settings.AntiAdmin.Enabled and player ~= Players.LocalPlayer and IsAdmin(player.Name) then
                print("[Protection] Admin mới join: " .. player.Name)
                HopToNewServer()
            end
        end)
        task.spawn(function()
            while task.wait(Settings.AntiAdmin.CheckInterval) do
                if Settings.AntiAdmin.Enabled then
                    CheckForAdmins()
                else
                    break
                end
            end
        end)
    end
    if Settings.AutoRejoin.Enabled then
        print("[Protection] Auto-Rejoin: Đã bật")
        game.StarterGui:SetCore("SendNotification", {
            Title = "KhanhlyHub",
            Text = "Auto-Rejoin: Đã bật!",
            Duration = 3
        })
        local promptGui = CoreGui:FindFirstChild("RobloxPromptGui")
        if promptGui then
            local promptOverlay = promptGui:FindFirstChild("promptOverlay")
            if promptOverlay then
                promptOverlay.ChildAdded:Connect(function(child)
                    if Settings.AutoRejoin.Enabled and child.Name == "ErrorPrompt" then
                        task.wait(1)
                        if IsKickPromptVisible() then
                            PerformRejoin()
                        end
                    end
                end)
            end
        end
        Players.PlayerRemoving:Connect(function(player)
            if Settings.AutoRejoin.Enabled and player == Players.LocalPlayer then
                task.wait(2)
                if not player:IsDescendantOf(game) then
                    PerformRejoin()
                end
            end
        end)
        task.spawn(function()
            while task.wait(10) do
                if Settings.AutoRejoin.Enabled and IsKickPromptVisible() then
                    PerformRejoin()
                end
            end
        end)
    end
end
InitProtectionSystem()
print("[Protection] KhanhlyHUB")

